#!/usr/bin/env bash
sleep 60
STAGE={{stage}}
{{configure.py}}
yum update -y
yum install -y docker jq python3
service docker start
mkdir /clair
REGION=`curl http://169.254.169.254/latest/dynamic/instance-identity/document|grep region|awk -F\" '{print $4}'`
AWS_DEFAULT_REGION=$REGION aws ssm get-parameter --name "clair-$STAGE-clair-config" --with-decryption | jq -r .Parameter.Value > /clair/clair-config.yaml
python3 -m venv /clair_python
source /clair_python/bin/activate
pip install pyyaml boto3
AWS_DEFAULT_REGION=$REGION STAGE=$STAGE python configure.py
docker run -d -p 6060-6061:6060-6061 -v /clair:/config:ro quay.io/coreos/clair:v2.0.5 -config=/config/clair-config.yaml
wget https://github.com/optiopay/klar/releases/download/v2.3.0/klar-2.3.0-linux-amd64
mv klar-2.3.0-linux-amd64 klar
chmod +x klar
